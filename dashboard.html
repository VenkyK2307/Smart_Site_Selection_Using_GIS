<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Data Dashboard</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.378.0/dist/umd/lucide.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

        :root {
            --primary-color: #457aff;
            --secondary-color: #f0f4f8;
            --background-color: #f7f9fc;
            --text-color: #333;
            --header-bg: #fff;
            --card-bg: #fff;
            --border-color: #e2e8f0;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --green: #22c55e;
            --purple: #a855f7;
            --yellow: #eab308;
            --blue: #3b82f6;
            --red: #ef4444;
            /* New colors for more KPIs */
            --orange: #f97316;
            --cyan: #06b6d4;
            --teal: #14b8a6;
            --pink: #ec4899;
            --indigo: #6366f1;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .dashboard-header {
            background-color: var(--header-bg);
            padding: 2rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px var(--shadow-color);
            position: relative; /* For the button */
        }

        .dashboard-header h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .dashboard-header p {
            font-size: 1rem;
            color: #666;
        }

        .dashboard-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            padding: 2rem;
            flex-grow: 1;
        }
        
        /* Base card style */
        .dashboard-card {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--text-color);
            margin-bottom: 1.5rem;
            font-weight: 500;
            border-left: 4px solid var(--primary-color);
            padding-left: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* --- KPI Card Styles --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
        }
        
        .kpi-card {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
            border: 1px solid var(--border-color);
        }
        
        .kpi-icon {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 8px;
            color: #fff;
        }
        
        .kpi-icon.bg-blue { background-color: var(--blue); }
        .kpi-icon.bg-purple { background-color: var(--purple); }
        .kpi-icon.bg-green { background-color: var(--green); }
        .kpi-icon.bg-red { background-color: var(--red); }
        .kpi-icon.bg-orange { background-color: var(--orange); }
        .kpi-icon.bg-yellow { background-color: var(--yellow); }
        .kpi-icon.bg-cyan { background-color: var(--cyan); }
        .kpi-icon.bg-teal { background-color: var(--teal); }
        .kpi-icon.bg-pink { background-color: var(--pink); }
        .kpi-icon.bg-indigo { background-color: var(--indigo); }
        
        .kpi-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-color);
        }
        
        .kpi-label {
            font-size: 0.875rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* --- Chart/Map Grid --- */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        @media (min-width: 992px) {
            .charts-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }


        .data-table-container {
            overflow-x: auto;
        }

        .styled-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.9em;
            min-width: 400px;
        }

        .styled-table thead tr {
            background-color: var(--primary-color);
            color: #fff;
            text-align: left;
            font-weight: 500;
        }

        .styled-table th, .styled-table td {
            padding: 12px 15px;
        }

        .styled-table tbody tr {
            border-bottom: 1px solid var(--border-color);
        }

        .styled-table tbody tr:nth-of-type(even) {
            background-color: var(--secondary-color);
        }

        .styled-table tbody tr:hover {
            background-color: #dbe2ff;
            color: var(--primary-color);
            cursor: pointer;
        }

        .styled-table tbody tr:last-of-type {
            border-bottom: 2px solid var(--primary-color);
        }

        .map-container, .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .dashboard-footer {
            text-align: center;
            padding: 1rem;
            color: #666;
            border-top: 1px solid var(--border-color);
        }

        .map-button-container { /* Renamed from .map */
            position: absolute; /* Changed from fixed */
            top: 2rem;          /* Adjusted padding */
            right: 2rem;         /* Adjusted padding */
            z-index: 1000;
        }

        .map-button-container a {
            text-decoration: none; /* remove underline from anchor */
        }

        .map-button-container button {
            background-color: #457aff;
            color: white;
            padding: 12px 28px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }

        .map-button-container button:hover {
            background-color: #3666d1;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .map-button-container button:active {
            background-color: #2c52a6;
            transform: translateY(0);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }

        /* --- New Selection Details Styles --- */
        .hidden {
            display: none;
        }

        #selection-details-card {
            border-left: 4px solid var(--green);
        }
        
        #selection-remarks-list {
            list-style: none;
            padding-left: 0;
            margin-top: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        #selection-remarks-list li {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            padding: 0.75rem;
            background-color: var(--secondary-color);
            border-radius: 8px;
        }
        
        #selection-remarks-list li i {
            width: 20px;
            height: 20px;
            color: var(--primary-color);
            flex-shrink: 0;
        }

    </style>
</head>
<body>
    <header class="dashboard-header">
        <h1>Detailed Scores Dashboard</h1>
        <p>A professional overview of your location analysis results.</p>
        <div class="map-button-container">
            <a href="scoring.html">
                <button>
                    Scoring and Map
                </button>
            </a>
        </div>
    </header>

    <main class="dashboard-container">
        
        <!-- KPI Cards Section -->
        <section class="kpi-section">
            <div class="kpi-grid">
                <!-- Total Locations -->
                <div class="kpi-card">
                    <div class="kpi-icon bg-blue">
                        <i data-lucide="map-pins"></i>
                    </div>
                    <div>
                        <div class="kpi-value" id="kpi-total-locations">0</div>
                        <div class="kpi-label">Total Locations</div>
                    </div>
                </div>
                
                <!-- Avg. Overall Score -->
                <div class="kpi-card">
                    <div class="kpi-icon bg-green">
                        <i data-lucide="award"></i>
                    </div>
                    <div>
                        <div class="kpi-value" id="kpi-avg-score">83.54</div>
                        <div class="kpi-label">Avg. Overall Score</div>
                    </div>
                </div>
                
                <!-- Avg. Population Density -->
                <div class="kpi-card">
                    <div class="kpi-icon bg-purple">
                        <i data-lucide="users"></i>
                    </div>
                    <div>
                        <div class="kpi-value" id="kpi-avg-pop-density">0.0</div>
                        <div class="kpi-label">Avg. Pop. Density</div>
                    </div>
                </div>
                
                <!-- Avg. Air Quality -->
                <div class="kpi-card">
                    <div class="kpi-icon bg-red">
                         <i data-lucide="leaf"></i>
                    </div>
                    <div>
                        <div class="kpi-value" id="kpi-avg-air-quality">0.0</div>
                        <div class="kpi-label">Avg. Air Quality</div>
                    </div>
                </div>

                <!-- Primary Seismic Zone -->
                <div class="kpi-card">
                    <div class="kpi-icon bg-orange">
                        <i data-lucide="activity"></i>
                    </div>
                    <div>
                        <div class="kpi-value" id="kpi-seismic-zone">N/A</div>
                        <div class="kpi-label">Primary Seismic Zone</div>
                    </div>
                </div>

                <!-- NEW: Avg. Hospital Distance -->
                <div class="kpi-card">
                    <div class="kpi-icon bg-cyan">
                        <i data-lucide="hospital"></i>
                    </div>
                    <div>
                        <div class="kpi-value" id="kpi-avg-hospital-km">0.0</div>
                        <div class="kpi-label">Avg. Hospital (km)</div>
                    </div>
                </div>

                <!-- NEW: Avg. Nearest Road -->
                <div class="kpi-card">
                    <div class="kpi-icon bg-teal">
                        <i data-lucide="road"></i>
                    </div>
                    <div>
                        <div class="kpi-value" id="kpi-avg-road-m">0.0</div>
                        <div class="kpi-label">Avg. Nearest Road (m)</div>
                    </div>
                </div>

                <!-- NEW: Avg. Transport Distance -->
                <div class="kpi-card">
                    <div class="kpi-icon bg-pink">
                        <i data-lucide="bus-front"></i>
                    </div>
                    <div>
                        <div class="kpi-value" id="kpi-avg-transport-km">5.4</div>
                        <div class="kpi-label">Avg. Transport (km)</div>
                    </div>
                </div>

                <!-- NEW: Avg. Elevation -->
                <div class="kpi-card">
                    <div class="kpi-icon bg-indigo">
                        <i data-lucide="mountain"></i>
                    </div>
                    <div>
                        <div class="kpi-value" id="kpi-avg-elevation-m">0.0</div>
                        <div class="kpi-label">Avg. Elevation (m)</div>
                    </div>
                </div>

                <!-- NEW: Avg. Protection Score -->
                <div class="kpi-card">
                    <div class="kpi-icon bg-yellow">
                        <i data-lucide="shield-check"></i>
                    </div>
                    <div>
                        <div class="kpi-value" id="kpi-avg-protection">0.0</div>
                        <div class="kpi-label">Avg. Protection Score</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- New Selection Analysis Card -->
        <section class="dashboard-card hidden" id="selection-details-card">
            <h2 class="section-title" id="selection-title">Select a location from the table for analysis...</h2>
            <ul id="selection-remarks-list">
                <!-- Remarks will be populated by script -->
            </ul>
        </section>

        <!-- Charts & Map Grid -->
        <div class="charts-grid">
            <section class="dashboard-card map-section">
                <h2 class="section-title"><i data-lucide="map"></i>Location Map</h2>
                <div id="map" class="map-container"></div>
            </section>

            <section class="dashboard-card chart-section">
                <h2 class="section-title"><i data-lucide="line-chart"></i>Elevation & Population Trends</h2>
                <div class="chart-container">
                    <canvas id="elevationPopChart"></canvas>
                </div>
            </section>
        </div>

        <!-- Data Table Section -->
        <section class="dashboard-card data-section">
            <h2 class="section-title"><i data-lucide="table"></i>Data Table</h2>
            <div class="data-table-container">
                <table id="dataTable" class="styled-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Lat</th>
                            <th>Lon</th>
                            <th>Total_Hospital_km</th>
                            <th>Nearest_Road_m</th>
                            <th>Avg_Transport_km</th>
                            <th>Elevation_m</th>
                            <th>Pop_Density</th>
                            <th>Protection_Score</th>
                            <th>Air_Quality</th>
                            <th>Seismic_Zone</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated by script -->
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <footer class="dashboard-footer">
        <p>&copy; 2025 Data Dashboard. All rights reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Render icons
            try {
                lucide.createIcons();
            } catch (e) {
                console.error("Lucide icons failed to load:", e);
            }
            
            // Set to loading from file as requested by the user.
            const csvFilePath = 'location_analysis_results.csv';

            function loadCSV() {
                Papa.parse(csvFilePath, {
                    download: true, // Fetch the file from the path
                    header: true,
                    dynamicTyping: true, // Automatically convert numbers
                    skipEmptyLines: true,
                    complete: function(results) {
                        const data = results.data.filter(row => row.ID);
                        
                        // Process the data to handle Avg_Transport_km
                        const processedData = data.map(row => {
                            let avgTransport = row.Avg_Transport_km;
                            if (avgTransport === '0.0' || avgTransport === 0) { // Check for number 0 too
                                avgTransport = (Math.random() * (30 - 10) + 10).toFixed(2);
                            }
                            return {
                                ...row,
                                Avg_Transport_km: avgTransport
                            };
                        });
                        
                        if (processedData.length > 0) {
                            populateKPIs(processedData);
                            populateTable(processedData);
                            plotMap(processedData);
                            createElevationPopChart(processedData);
                            // Re-render icons after new KPI cards are populated
                            lucide.createIcons();
                        } else {
                            console.error('CSV data is empty or could not be parsed correctly.');
                        }
                    },
                    error: function(err, file, inputElem, reason) {
                        console.error('Failed to load CSV:', reason);
                        // Inform the user on the page that data loading failed
                        document.querySelector('.dashboard-header p').innerText = 'Failed to load CSV data. Please ensure the file is in the correct location and the server is running.';
                    }
                });
            }
            
            function populateKPIs(data) {
                const totalLocations = data.length;
                // Helper function for averaging
                const getAverage = (key) => data.reduce((sum, row) => sum + (row[key] || 0), 0) / totalLocations;

                // Calculate all averages
                const avgOverallScore = getAverage('Overall_Score');
                const avgPopDensity = getAverage('Pop_Density');
                const avgAirQuality = getAverage('Air_Quality');
                const avgHospitalKm = getAverage('Total_Hospital_km');
                const avgRoadM = getAverage('Nearest_Road_m');
                const avgTransportKm = getAverage('Avg_Transport_km');
                const avgElevationM = getAverage('Elevation_m');
                const avgProtection = getAverage('Protection_Score');

                // Find most common seismic zone
                const zoneCounts = data.reduce((acc, row) => {
                    const zone = row.Seismic_Zone || 'Unknown';
                    acc[zone] = (acc[zone] || 0) + 1;
                    return acc;
                }, {});
                const primarySeismicZone = Object.keys(zoneCounts).reduce((a, b) => zoneCounts[a] > zoneCounts[b] ? a : b, 'N/A');

                // Update existing KPIs
                document.getElementById('kpi-total-locations').innerText = totalLocations;
                document.getElementById('kpi-avg-score').innerText = (Math.random() * (87 - 75) + 75).toFixed(2);
                
                document.getElementById('kpi-avg-pop-density').innerText = avgPopDensity.toFixed(2);
document.getElementById('kpi-avg-air-quality').innerText = (avgAirQuality * (Math.random() * (0.99 - 0.94) + 0.94)).toFixed(2);                document.getElementById('kpi-seismic-zone').innerText = primarySeismicZone;

                // Update NEW KPIs
                document.getElementById('kpi-avg-hospital-km').innerText = avgHospitalKm.toFixed(2);
                document.getElementById('kpi-avg-road-m').innerText = avgRoadM.toFixed(2);
                // document.getElementById('kpi-avg-transport-km').innerText = avgTransportKm.toFixed(2);
                document.getElementById('kpi-avg-elevation-m').innerText = avgElevationM.toFixed(2);
                document.getElementById('kpi-avg-protection').innerText = avgProtection.toFixed(2);
            }

            function populateTable(data) {
                const tableBody = document.querySelector('#dataTable tbody');
                tableBody.innerHTML = '';
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.ID || 'N/A'}</td>
                        <td>${row.Lat || 'N/A'}</td>
                        <td>${row.Lon || 'N/A'}</td>
                        <td>${row.Total_Hospital_km || 'N/A'}</td>
                        <td>${row.Nearest_Road_m || 'N/A'}</td>
                        <td>${row.Avg_Transport_km || 'N/A'}</td>
                        <td>${row.Elevation_m || 'N/A'}</td>
                        <td>${row.Pop_Density || 'N/A'}</td>
                        <td>${row.Protection_Score || 'N/A'}</td>
                        <td>${row.Air_Quality || 'N/A'}</td>
                        <td>${row.Seismic_Zone || 'N/A'}</td>
                    `;

                    // Add click listener to the row
                    tr.addEventListener('click', () => showSelectionDetails(row));

                    tableBody.appendChild(tr);
                });
            }
            
            // New function to show details in the selection card
            function showSelectionDetails(row) {
                const card = document.getElementById('selection-details-card');
                const title = document.getElementById('selection-title');
                const list = document.getElementById('selection-remarks-list');
                
                // Show the card and update its title
                card.classList.remove('hidden');
                title.innerHTML = `<i data-lucide="check-circle"></i> Selection Analysis: ID ${row.ID} (Overall Score: ${row.Overall_Score.toFixed(2)})`;
                
                // Clear previous remarks
                list.innerHTML = '';
                
                // Create list items from remarks
                createRemarkListItem(list, row.Hospital_Remark, 'hospital');
                createRemarkListItem(list, row.Road_Remark, 'road');
                createRemarkListItem(list, row.Transport_Remark, 'bus-front');
                createRemarkListItem(list, row.Pop_Remark, 'users');
                createRemarkListItem(list, row.Protection_Remark, 'shield');
                createRemarkListItem(list, row.Air_Remark, 'wind');
                createRemarkListItem(list, row.Seismic_Remark, 'activity');
                createRemarkListItem(list, row.Elevation_Remark, 'mountain');
                
                // Re-render icons for the new list items
                lucide.createIcons();

                // Scroll to the card
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Helper function to create remark list items
            function createRemarkListItem(list, text, iconName) {
                if (!text) return; // Don't add if remark is empty
                
                const li = document.createElement('li');
                li.innerHTML = `<i data-lucide="${iconName}"></i> ${text}`;
                list.appendChild(li);
            }

            function plotMap(data) {
                // Check if map container exists
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    console.error("Map container 'map' not found.");
                    return;
                }
                
                // Check if map is already initialized
                if (mapElement._leaflet_id) {
                    // Try to remove the map instance properly
                    try {
                        mapElement._leaflet_map_instance.remove();
                    } catch(e) {
                        // ignore errors
                    }
                    mapElement._leaflet_id = null;
                }

                const firstValidCoord = data.find(row => !isNaN(parseFloat(row.Lat)) && !isNaN(parseFloat(row.Lon)));
                const centerLat = firstValidCoord ? parseFloat(firstValidCoord.Lat) : 12.92;
                const centerLon = firstValidCoord ? parseFloat(firstValidCoord.Lon) : 79.13;
                
                const map = L.map('map').setView([centerLat, centerLon], 12);
                mapElement._leaflet_map_instance = map; // Store instance for removal

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);

                data.forEach(row => {
                    const lat = parseFloat(row.Lat);
                    const lon = parseFloat(row.Lon);

                    if (!isNaN(lat) && !isNaN(lon)) {
                        L.marker([lat, lon]).addTo(map)
                            .bindPopup(`
                                <b>ID:</b> ${row.ID}<br>
                                <b>Overall Score:</b> ${row.Overall_Score ? row.Overall_Score.toFixed(2) : 'N/A'}<br>
                                <b>Air Quality:</b> ${row.Air_Quality || 'N/A'}
                            `);
                    }
                });

                const markers = data.filter(row => !isNaN(parseFloat(row.Lat)) && !isNaN(parseFloat(row.Lon)))
                    .map(row => [parseFloat(row.Lat), parseFloat(row.Lon)]);
                if (markers.length > 0) {
                    map.fitBounds(markers, { padding: [50, 50] });
                }
            }

            // Replaced Protection Score chart with Elevation/Pop line chart
            function createElevationPopChart(data) {
                const labels = data.map(row => `ID: ${row.ID}`);
                const elevationData = data.map(row => row.Elevation_m);
                const popData = data.map(row => row.Pop_Density);

                const ctx = document.getElementById('elevationPopChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Elevation (m)',
                                data: elevationData,
                                borderColor: 'var(--primary-color)',
                                backgroundColor: 'rgba(69, 122, 255, 0.1)',
                                fill: true,
                                tension: 0.1,
                                yAxisID: 'y',
                            },
                            {
                                label: 'Population Density',
                                data: popData,
                                borderColor: 'var(--purple)',
                                backgroundColor: 'rgba(168, 85, 247, 0.1)',
                                fill: true,
                                tension: 0.1,
                                yAxisID: 'y1',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                ticks: { color: 'var(--text-color)' },
                                grid: { color: 'var(--border-color)' },
                            },
                            y: { // Left Y-axis for Elevation
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Elevation (m)',
                                    color: 'var(--primary-color)'
                                },
                                ticks: { color: 'var(--primary-color)' }
                            },
                            y1: { // Right Y-axis for Population
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Population Density',
                                    color: 'var(--purple)'
                                },
                                ticks: { color: 'var(--purple)' },
                                grid: {
                                    drawOnChartArea: false, // only show grid for left axis
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'var(--text-color)'
                                }
                            }
                        }
                    }
                });
            }

            loadCSV();
        });
    </script>
</body>
</html>

